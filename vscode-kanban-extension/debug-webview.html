<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Kanban Board</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1e1e1e;
            color: #fff;
        }
        .debug-info {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        .success { color: #4ec9b0; }
        .error { color: #f44747; }
        .warning { color: #dcdcaa; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1177bb;
        }
        #boardList {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .board-item {
            background: #3c3c3c;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            border-left: 3px solid #0e639c;
        }
    </style>
</head>
<body>
    <h1>üîç Kanban Board Debug Interface</h1>
    
    <div class="debug-info">
        <strong>VSCode Context:</strong> <span id="vscodeStatus">Checking...</span><br>
        <strong>API Available:</strong> <span id="apiStatus">Checking...</span><br>
        <strong>Server URL:</strong> <span id="serverUrl">Unknown</span><br>
        <strong>Request Count:</strong> <span id="requestCount">0</span>
    </div>

    <div>
        <button onclick="testApiConnection()">Test API</button>
        <button onclick="fetchBoards()">Fetch Boards</button>
        <button onclick="clearLog()">Clear Log</button>
        <button onclick="openInBrowser()">Open in Browser</button>
    </div>

    <div id="boardList">
        <h3>üìã Boards:</h3>
        <div id="boards">No boards loaded yet</div>
    </div>

    <div class="debug-info">
        <h3>üìù Debug Log:</h3>
        <div id="debugLog">Initializing debug interface...</div>
    </div>

    <script>
        let requestCount = 0;
        let debugLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push(logEntry);
            
            const logDiv = document.getElementById('debugLog');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML = debugLog.map(entry => 
                `<div class="${className}">${entry}</div>`
            ).join('');
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            debugLog = [];
            document.getElementById('debugLog').innerHTML = 'Log cleared.';
        }
        
        function updateRequestCount() {
            requestCount++;
            document.getElementById('requestCount').textContent = requestCount;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Debug interface loaded');
            
            // Check VSCode context
            const vscodeAvailable = typeof window.vscode !== 'undefined';
            document.getElementById('vscodeStatus').textContent = vscodeAvailable ? 'Available ‚úÖ' : 'Not Available ‚ùå';
            document.getElementById('vscodeStatus').className = vscodeAvailable ? 'success' : 'error';
            
            if (vscodeAvailable) {
                log('‚úÖ VSCode API available');
                
                // Check for server URL
                const serverUrl = window.API_BASE_URL || 'Unknown';
                document.getElementById('serverUrl').textContent = serverUrl;
                log(`üîó API Base URL: ${serverUrl}`);
                
                // Set up message listener for API responses
                if (window.vsCodeApiRequest) {
                    log('‚úÖ VSCode API request function available');
                } else {
                    log('‚ö†Ô∏è VSCode API request function not available, using fallback');
                }
            } else {
                log('‚ùå Not running in VSCode webview context');
            }
        });
        
        // API testing function
        async function testApiConnection() {
            log('üîÑ Testing API connection...');
            updateRequestCount();
            
            try {
                if (typeof window.vscode !== 'undefined') {
                    // Use VSCode message passing
                    const response = await makeApiRequest('GET', '/boards');
                    log(`‚úÖ API test successful: ${JSON.stringify(response)}`, 'success');
                } else {
                    log('‚ùå Cannot test API - not in VSCode context', 'error');
                }
            } catch (error) {
                log(`‚ùå API test failed: ${error.message}`, 'error');
            }
        }
        
        // Fetch boards function
        async function fetchBoards() {
            log('üìã Fetching boards...');
            updateRequestCount();
            
            try {
                const boards = await makeApiRequest('GET', '/boards');
                log(`‚úÖ Fetched ${boards.length} boards`, 'success');
                
                const boardsDiv = document.getElementById('boards');
                if (boards.length === 0) {
                    boardsDiv.innerHTML = '<div class="warning">No boards found</div>';
                } else {
                    boardsDiv.innerHTML = boards.map(board => `
                        <div class="board-item">
                            <strong>${board.name}</strong><br>
                            <small>ID: ${board.id}</small><br>
                            <small>Goal: ${board.goal}</small><br>
                            <small>Created: ${new Date(board.createdAt).toLocaleString()}</small>
                        </div>
                    `).join('');
                }
            } catch (error) {
                log(`‚ùå Failed to fetch boards: ${error.message}`, 'error');
                document.getElementById('boards').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        // API request helper
        function makeApiRequest(method, endpoint, data) {
            return new Promise((resolve, reject) => {
                if (typeof window.vscode === 'undefined') {
                    reject(new Error('VSCode API not available'));
                    return;
                }
                
                const requestId = `debug_req_${Date.now()}_${Math.random()}`;
                
                // Set up response handler
                const handleMessage = (event) => {
                    const message = event.data;
                    if (message.type === 'apiResponse' && message.requestId === requestId) {
                        window.removeEventListener('message', handleMessage);
                        if (message.success) {
                            resolve(message.data);
                        } else {
                            reject(new Error(message.error || 'Unknown error'));
                        }
                    }
                };
                
                window.addEventListener('message', handleMessage);
                
                // Send request
                window.vscode.postMessage({
                    type: 'apiRequest',
                    requestId: requestId,
                    method: method,
                    endpoint: endpoint,
                    data: data
                });
                
                // Timeout after 5 seconds
                setTimeout(() => {
                    window.removeEventListener('message', handleMessage);
                    reject(new Error('Request timeout'));
                }, 5000);
            });
        }
        
        // Open in browser function
        function openInBrowser() {
            if (typeof window.vscode !== 'undefined') {
                const serverUrl = window.API_BASE_URL || 'http://localhost:50736';
                window.vscode.postMessage({
                    type: 'openExternal',
                    url: serverUrl
                });
                log(`üåê Opening ${serverUrl} in external browser`);
            } else {
                log('‚ùå Cannot open in browser - not in VSCode context', 'error');
            }
        }
    </script>
</body>
</html>